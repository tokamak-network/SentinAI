# Lessons Learned

## 2026-02-16

- 분기 로직에서 공통 변수 재초기화는 상위 분기 값을 쉽게 덮어쓴다.
  - 규칙: `seed/live`처럼 의미가 다른 경로는 계산 함수를 분리하고, 공유 변수 재할당을 최소화한다.
- 타입 단언(`as`)으로 런타임 계약을 축소하면 결함이 숨겨진다.
  - 규칙: 스케일링 tier 같은 핵심 도메인은 공통 타입 별칭을 만들고 전 구간에서 동일 타입을 사용한다.
- 동일한 외부 RPC 호출 패턴은 타임아웃/재시도 정책을 통일해야 한다.
  - 규칙: API/agent-loop 모두 공통 fetch 유틸 또는 동일 타임아웃 정책을 강제한다.
- 관측 API의 메타데이터(`source`)는 실제 데이터 경로(seed/live)와 반드시 일치해야 한다.
  - 규칙: 응답 필드는 하드코딩하지 말고, 분기 결과에서 파생된 값을 단일 변수로 설정한다.
- 인증 면제 경로는 접두사 매칭보다 정확 경로 매칭이 안전하다.
  - 규칙: 민감한 미들웨어 예외는 `startsWith` 대신 exact allowlist를 기본값으로 사용한다.
