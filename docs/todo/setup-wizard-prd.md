# PRD: Setup Wizard v2

## Problem

The current `npm run setup` (`scripts/setup.mjs`, 668 lines) has issues:

1. **Too many questions** — asks about AI provider details, K8s config, Proxyd, EOA, LLM test all at once
2. **No progressive disclosure** — beginners see the same 30+ questions as power users
3. **No validation feedback** — user enters an API key but doesn't know if it works until they run the app
4. **No resume** — if you quit halfway, you start over
5. **Outdated variables** — still references deprecated vars (`L1_RPC_URL`, `K8S_STATEFULSET_PREFIX`, `EOA_BALANCE_EMERGENCY_ETH`)

## Goal

A step-by-step CLI wizard that:
- Gets users running in **under 60 seconds** (Quick mode: 3 questions)
- Validates inputs in real-time (RPC connectivity, API key validity, K8s access)
- Generates a clean `.env.local` with only what's needed
- Can be re-run safely to add/modify specific sections

## Design

### Flow

```
npm run setup

┌─────────────────────────────────────┐
│  SentinAI Setup Wizard              │
│  ─────────────────────              │
│  Existing .env.local detected.      │
│  • Reconfigure from scratch         │
│  • Modify specific section          │
│  • Validate current config          │
└─────────────────────────────────────┘
```

### Steps (Progressive)

```
Step 1: L2 RPC          (required)
  → Enter URL → validate connection → show chain ID & block height

Step 2: AI Provider      (required for AI features)
  → Pick provider (Anthropic/OpenAI/Gemini/Qwen)
  → Enter API key → test with a simple completion → show ✓

Step 3: K8s Monitoring   (optional, skip by default)
  → "Do you have a K8s cluster to monitor? (y/N)"
  → If yes: enter cluster name → validate with aws eks describe-cluster
  → Show: region, endpoint, namespace

Step 4: L1 RPC           (optional, skip by default)
  → "Custom L1 RPC endpoints? (y/N)"
  → If yes: enter comma-separated URLs → test each → show latency
  → Default: publicnode.com (no config needed)

Step 5: EOA Monitoring   (optional, skip by default)  
  → "Monitor batcher/proposer ETH balances? (y/N)"
  → If yes: enter addresses or private keys
  → Optional: treasury key for auto-refill

Step 6: Alerts           (optional, skip by default)
  → "Set up webhook alerts? (y/N)"
  → If yes: enter webhook URL → send test message → confirm delivery

Step 7: Summary & Write
  → Show all configured values (masked secrets)
  → Write .env.local
  → "Run `npm run dev` to start SentinAI"
```

### Modify Mode

When `.env.local` already exists, allow modifying a specific section:

```
What would you like to configure?
  1. L2 RPC
  2. AI Provider
  3. K8s Monitoring
  4. L1 RPC
  5. EOA Monitoring
  6. Alerts
  7. Advanced (Redis, Cost Tracking, Cloudflare, etc.)
```

### Validate Mode

Run all validation checks on existing `.env.local`:

```
Validating .env.local...
  ✓ L2_RPC_URL          connected (chain 111551119090, block #4,521,003)
  ✓ ANTHROPIC_API_KEY    valid (claude-haiku-4.5 responding)
  ✓ AWS_CLUSTER_NAME     found (us-east-1, endpoint reachable)
  ✗ L1_RPC_URLS          endpoint 2/3 unreachable (https://rpc.sepolia.org)
  ○ EOA addresses        not configured (optional)
  ○ ALERT_WEBHOOK_URL    not configured (optional)
```

## Technical Spec

### Stack
- **Runtime**: Node.js (ESM, `scripts/setup.mjs`)
- **No dependencies**: Use only `node:readline`, `node:fs`, `node:child_process`, `node:https`
- **Validation**: Direct HTTP requests for RPC/API testing (no SDK needed)

### Validation Methods

| Check | Method |
|---|---|
| L2 RPC | `POST` with `eth_chainId` + `eth_blockNumber` JSON-RPC |
| AI key (Anthropic) | `POST /v1/messages` with minimal prompt, check 200 |
| AI key (OpenAI) | `POST /v1/chat/completions` with minimal prompt, check 200 |
| AI key (Gemini) | `POST /v1beta/models/gemini-2.5-flash-lite:generateContent` |
| AI key (Qwen) | `POST /v1/chat/completions` to DashScope endpoint |
| K8s cluster | `aws eks describe-cluster --name <name>` via execFileSync |
| L1 RPC | `POST` with `eth_blockNumber`, measure latency per endpoint |
| Webhook | `POST` with test payload, check 2xx response |

### .env.local Generation

- Only write variables the user explicitly configured
- Comment out optional sections with descriptive headers
- Preserve any existing variables not covered by the wizard (don't clobber custom vars)

### Output Format

```bash
# ==========================================
# SentinAI Configuration
# Generated by setup wizard on 2026-02-14
# Docs: docs/guide/ENV_GUIDE.md
# ==========================================

# === Required ===
L2_RPC_URL=https://rpc.titok.tokamak.network

# === AI Provider ===
ANTHROPIC_API_KEY=sk-ant-xxx

# === K8s Monitoring ===
# Not configured. Run `npm run setup` to add.

# === L1 RPC ===
# Using default (publicnode.com). Run `npm run setup` to customize.

# === EOA Monitoring ===
# Not configured. Run `npm run setup` to add.

# === Alerts ===
# Not configured. Run `npm run setup` to add.
```

## UX Guidelines

1. **Color output**: Green ✓ for success, Red ✗ for failure, Yellow ○ for skipped
2. **Smart defaults**: Pre-fill with detected values (e.g., AWS region from `aws configure`)
3. **Masked secrets**: Show `sk-ant-...BcFg` format for API keys in summary
4. **Non-destructive**: Always back up existing `.env.local` before overwriting
5. **Exit gracefully**: Ctrl+C shows "Setup cancelled. No changes made."

## Scope

### In Scope
- Replace current `scripts/setup.mjs` entirely
- All validation checks listed above
- Fresh / Modify / Validate modes
- `.env.local` backup before overwrite

### Out of Scope
- Web UI (future: Telegram Mini App onboarding)
- L1 Proxyd advanced config (point to docs instead)
- LLM stress test config (moved to `.env.test.sample`)
- Auto-refill fine-tuning params (use defaults, point to docs)

## Success Criteria

- [ ] New user can go from `git clone` to running dashboard in < 60 seconds
- [ ] Re-running setup preserves existing config unless explicitly changed
- [ ] All validation checks pass/fail with clear feedback
- [ ] Zero external dependencies (pure Node.js)
- [ ] Deprecated env vars (`L1_RPC_URL`, `K8S_STATEFULSET_PREFIX`, `EOA_BALANCE_EMERGENCY_ETH`) not shown
